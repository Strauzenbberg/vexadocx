<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VEXA // PDF to DOCX Ultimate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://unpkg.com/docx@8.2.2/build/index.js"></script>
    <style>
        :root { 
            --primary: #007AFF; 
            --bg: #050505; 
            --card: #121214; 
            --text: #ffffff; 
            --text-dim: #8e8e93;
        }

        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: -apple-system, system-ui, sans-serif; 
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 40px; 
        }

        .container { width: 100%; max-width: 500px; text-align: center; }
        
        h1 { font-size: 64px; font-weight: 900; letter-spacing: -4px; margin-bottom: 10px; background: linear-gradient(#fff, #444); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .upload-area { 
            background: var(--card); border: 1px solid #2c2c2e; border-radius: 32px; padding: 40px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5); margin-top: 20px;
        }

        .drop-zone { 
            border: 2px dashed #3a3a3c; border-radius: 20px; padding: 50px 20px; 
            cursor: pointer; transition: 0.4s cubic-bezier(0.2, 0, 0, 1);
        }

        .drop-zone:hover { border-color: var(--primary); transform: scale(1.02); background: rgba(0,122,255,0.03); }

        .btn-main { 
            width: 100%; background: #fff; color: #000; padding: 20px; border-radius: 18px; 
            font-weight: 800; border: none; cursor: pointer; margin-top: 20px; font-size: 16px;
            transition: 0.3s;
        }

        .btn-main:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(255,255,255,0.1); }
        .btn-main:disabled { background: #1c1c1e; color: #444; cursor: not-allowed; }

        #terminal { 
            background: #000; border: 1px solid #1c1c1e; border-radius: 18px; padding: 20px;
            margin-top: 30px; font-family: 'Courier New', monospace; font-size: 12px;
            text-align: left; color: #00ff00; height: 150px; overflow-y: auto;
        }

        input[type="file"] { display: none; }
        .loading { display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>VEXA</h1>
    <p style="color: var(--text-dim); letter-spacing: 2px;">ULTIMATE CONVERTER</p>

    <div class="upload-area">
        <div class="drop-zone" id="drop-zone">
            <p id="file-name">Arraste seu PDF ou clique para selecionar</p>
        </div>
        <input type="file" id="file-input" accept=".pdf">
        <button id="convert-btn" class="btn-main" disabled>AGUARDANDO MOTOR...</button>
    </div>

    <div id="terminal">> Inicializando núcleo VEXA...</div>
</div>

<script>
    const terminal = document.getElementById('terminal');
    const btn = document.getElementById('convert-btn');
    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    const log = (msg) => {
        terminal.innerHTML += `<div>> ${msg}</div>`;
        terminal.scrollTop = terminal.scrollHeight;
    };

    // Verifica se as bibliotecas carregaram
    const checkInit = setInterval(() => {
        if (window.docx && window.pdfjsLib) {
            log("Motores prontos. Pronto para conversão de alto nível.");
            btn.innerText = "CONVERTER PARA DOCX";
            btn.disabled = false;
            clearInterval(checkInit);
        }
    }, 1000);

    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = () => {
        if(fileInput.files[0]) document.getElementById('file-name').innerText = fileInput.files[0].name;
    };

    btn.onclick = async () => {
        const file = fileInput.files[0];
        if (!file) return;

        btn.disabled = true;
        btn.innerText = "RECONSTRUINDO LAYOUT...";
        log(`Processando: ${file.name}`);

        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const sections = [];

            for (let i = 1; i <= pdf.numPages; i++) {
                log(`Mapeando página ${i}/${pdf.numPages}...`);
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                // Estratégia de Reconstrução de Linhas (mantém o layout editável)
                let lastY;
                let textRuns = [];
                let paragraphs = [];

                for (let item of textContent.items) {
                    if (lastY !== undefined && Math.abs(item.transform[5] - lastY) > 5) {
                        paragraphs.push(new docx.Paragraph({ children: textRuns }));
                        textRuns = [];
                    }
                    
                    textRuns.push(new docx.TextRun({
                        text: item.str + (item.hasEOL ? "" : " "),
                        size: 22, // ~11pt
                        font: "Calibri"
                    }));
                    lastY = item.transform[5];
                }
                
                // Adiciona o último parágrafo da página
                if (textRuns.length > 0) paragraphs.push(new docx.Paragraph({ children: textRuns }));
                
                // Adiciona quebra de página se não for a última
                if (i < pdf.numPages) paragraphs.push(new docx.Paragraph({ children: [new docx.PageBreak()] }));

                sections.push({ children: paragraphs });
            }

            log("Gerando binários DOCX...");
            const doc = new docx.Document({ sections });

            const blob = await docx.Packer.toBlob(doc);
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name.replace(".pdf", ".docx");
            document.body.appendChild(a);
            a.click();
            
            log("✨ CONVERSÃO CONCLUÍDA COM SUCESSO!");
            btn.disabled = false;
            btn.innerText = "CONVERTER OUTRO PDF";

        } catch (err) {
            log(`ERRO CRÍTICO: ${err.message}`);
            btn.disabled = false;
            btn.innerText = "TENTAR NOVAMENTE";
        }
    };
</script>
</body>
</html>
