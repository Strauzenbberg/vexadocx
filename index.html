<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>VEXA ENTERPRISE â€” PDF to DOCX</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PDF.JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<!-- DOCX (UMD - OBRIGATÃ“RIO) -->
<script src="https://unpkg.com/docx@8.2.2/build/index.umd.js"></script>

<!-- OCR -->
<script src="https://unpkg.com/tesseract.js@5.0.4/dist/tesseract.min.js"></script>

<style>
body{background:#050505;color:#fff;font-family:system-ui;display:flex;flex-direction:column;align-items:center;padding:50px}
button{padding:16px 22px;border:none;border-radius:14px;font-weight:700;cursor:pointer;margin-top:10px}
#log{margin-top:20px;width:420px;height:180px;background:#000;color:#00ff9c;font-family:monospace;font-size:12px;padding:14px;overflow:auto}
input{display:none}
</style>
</head>

<body>

<h1>VEXA ENTERPRISE</h1>

<button onclick="file.click()">Selecionar PDF</button>
<input type="file" id="file" accept=".pdf">

<button id="run">Converter Agora</button>

<div id="log">> Sistema pronto</div>

<script>
/* ðŸ”§ WORKER FIX */
pdfjsLib.GlobalWorkerOptions.workerSrc =
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const log = m => {
    const el = document.getElementById("log");
    el.innerHTML += `<div>> ${m}</div>`;
    el.scrollTop = el.scrollHeight;
};

document.getElementById("run").onclick = async () => {
    const input = document.getElementById("file");
    if (!input.files[0]) return alert("Selecione um PDF");

    try {
        log("Carregando PDF...");
        const buffer = await input.files[0].arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
        log(`PDF com ${pdf.numPages} pÃ¡ginas`);

        /* âœ… DOCX AGORA EXISTE */
        const { Document, Packer, Paragraph, TextRun } = window.docx;
        const paragraphs = [];

        for (let i = 1; i <= pdf.numPages; i++) {
            log(`PÃ¡gina ${i}`);
            const page = await pdf.getPage(i);
            const text = await page.getTextContent();

            if (text.items.length > 15) {
                let bufferLine = "";
                let lastY = null;

                text.items.forEach(it => {
                    if (lastY && Math.abs(it.transform[5] - lastY) > 12) {
                        paragraphs.push(new Paragraph({
                            children:[new TextRun({ text: bufferLine, size:22 })],
                            spacing:{ after:200 }
                        }));
                        bufferLine = "";
                    }
                    bufferLine += it.str + " ";
                    lastY = it.transform[5];
                });

                if (bufferLine.trim()) {
                    paragraphs.push(new Paragraph({
                        children:[new TextRun({ text: bufferLine, size:22 })]
                    }));
                }
            } else {
                log("OCR ativado");
                const viewport = page.getViewport({ scale: 2 });
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                await page.render({ canvasContext: ctx, viewport }).promise;
                const ocr = await Tesseract.recognize(canvas, "por");

                ocr.data.paragraphs.forEach(p => {
                    paragraphs.push(new Paragraph({
                        children:[new TextRun({ text: p.text, size:22 })],
                        spacing:{ after:200 }
                    }));
                });
            }
        }

        if (!paragraphs.length) throw new Error("Nenhum texto extraÃ­do");

        log("Gerando DOCX...");
        const doc = new Document({ sections:[{ children: paragraphs }] });
        const blob = await Packer.toBlob(doc);

        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = input.files[0].name.replace(".pdf",".docx");
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        log("Download iniciado com sucesso");

    } catch (err) {
        console.error(err);
        log("ERRO: " + err.message);
    }
};
</script>

</body>
</html>
